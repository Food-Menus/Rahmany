<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>البحث عن بيانات العمال</title>
  <style>
/* تنسيق عام للصفحة */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #cfa363, #fb6b23);
    background-size: 400% 400%;
    animation: gradientBG 15s ease infinite;
    margin: 0;
    min-height: 100vh;
    color: #fff;
    padding: 20px;
}

@keyframes gradientBG {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

/* تنسيق الحاوية الرئيسية */
.container {
    background: rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(10px);
    padding: 2.5rem;
    border-radius: 15px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    width: 100%;
    max-width: 600px;
    margin: 2rem auto;
    border: 1px solid rgba(255, 255, 255, 0.1);
    animation: fadeIn 1s ease;
}

/* تنسيق مجموعة الحقول */
.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
}

.form-group input,
.form-group select {
    width: 90%;
    margin: 5px;
    padding: 0.8rem 1rem;
    background: rgb(255, 255, 255);
    border: 1px solid rgba(255, 255, 255, 0.5);
    border-radius: 8px;
    color: rgb(0, 0, 0);
    font-size: 1rem;
    transition: all 0.3s ease;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: rgba(255, 255, 255, 0.8);
    background: rgba(255, 255, 255, 0.2);
}

/* تنسيق أزرار */
button {
    width: 100%;
    padding: 0.8rem;
    background: rgba(255, 255, 255, 0.15);
    border: none;
    border-radius: 8px;
    color: white;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    margin-top: 1rem;
}

/* تنسيق رسائل النظام */
.message {
    margin-top: 1rem;
    padding: 1rem;
    border-radius: 8px;
    text-align: center;
    display: none;
}

.success {
    background: rgba(46, 125, 50, 0.3);
}

.error {
    background: rgba(211, 47, 47, 0.3);
}

/* تأثيرات الحركة */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}
  </style>
</head>
<body>
  <div class="container">
    <h2>البحث عن بيانات العمال</h2>

    <div class="form-group">
      <label for="shiftNumber">رقم الوردية (يتم جلبه تلقائيًا من التخزين المحلي)</label>
      <input type="text" id="shiftNumber" readonly class="read-only-field">
    </div>

    <div class="form-group">
      <label for="jobTypeSelect">اسم العمل:</label>
      <select id="jobTypeSelect">
        <option value="">اختر اسم العمل</option>
      </select>
    </div>

    <div class="form-group">
      <label for="workerNameSelect">اسم العامل:</label>
      <select id="workerNameSelect" disabled>
        <option value="">اختر اسم العامل</option>
      </select>
    </div>

    <button id="searchButton" disabled>بحث</button>
    <div id="loadingMessage">جاري التحميل...</div>
    <div id="statusMessage" class="message" style="display: none;"></div>

    <div id="workerData" style="display: none;">
      <h3>بيانات العامل:</h3>
      <div class="form-group">
        <label>اسم العامل:</label>
        <input type="text" id="displayWorkerName" readonly class="read-only-field">
      </div>
      <div class="form-group">
        <label>نوع الوظيفة:</label>
        <input type="text" id="displayJobType" readonly class="read-only-field">
      </div>
      <div class="form-group">
        <label>سعر الساعة:</label>
        <input type="number" id="displayHourlyRate" readonly class="read-only-field">
      </div>
      <div class="form-group">
        <label>نوع الوردية:</label>
        <input type="text" id="displayShiftType" readonly class="read-only-field">
      </div>

      <div class="form-group">
        <label for="inputComeTime">وقت الحضور:</label>
        <input type="text" id="inputComeTime">
      </div>
      <div class="form-group">
        <label for="inputNumOfHours">عدد ساعات العمل:</label>
        <input type="number" id="inputNumOfHours">
      </div>
      <div class="form-group">
        <label for="inputDiscountWorker">الخصم:</label>
        <input type="number" id="inputDiscountWorker">
      </div>
      <div class="form-group">
        <label>مصروف يومي:</label>
        <input type="number" id="displayDayExpence" readonly class="read-only-field">
      </div>
      
      <button id="updateButton">تحديث البيانات</button>
    </div>
  </div>

  <script>
    const scriptUrl = 'https://script.google.com/macros/s/AKfycbw4rHSV3lbB_kI52_TElC2VKCw631Vi8tw5QZDKSr3qzkFg-CqcC-MpX4uvl-rB-Fsf/exec'; // استبدل هذا باللينك الخاص بك
    const dataSheetUrl = 'https://docs.google.com/spreadsheets/d/1g2sSqoDAxgKO9LHI_jCtFydenS7OXpINLhec26IpJE8/gviz/tq?tqx=out:json'; // لينك جدول البيانات

    let allWorkersData = [];
    let currentRowIndex = null; // لتخزين رقم الصف الذي تم جلبه للبحث والتعديل

    document.addEventListener('DOMContentLoaded', () => {
      const shiftNumberInput = document.getElementById('shiftNumber');
      const jobTypeSelect = document.getElementById('jobTypeSelect');
      const workerNameSelect = document.getElementById('workerNameSelect');
      const searchButton = document.getElementById('searchButton');
      const updateButton = document.getElementById('updateButton');
      const loadingMessage = document.getElementById('loadingMessage');
      const statusMessage = document.getElementById('statusMessage');
      const workerDataSection = document.getElementById('workerData');

      const displayWorkerName = document.getElementById('displayWorkerName');
      const displayJobType = document.getElementById('displayJobType');
      const displayHourlyRate = document.getElementById('displayHourlyRate');
      const displayShiftType = document.getElementById('displayShiftType');
      const displayDayExpence = document.getElementById('displayDayExpence');

      const inputComeTime = document.getElementById('inputComeTime');
      const inputNumOfHours = document.getElementById('inputNumOfHours');
      const inputDiscountWorker = document.getElementById('inputDiscountWorker');

      // جلب رقم الوردية من localStorage
      const storedShiftNumber = localStorage.getItem('shiftNumber');
      if (storedShiftNumber) {
        shiftNumberInput.value = storedShiftNumber;
      } else {
        // يمكنك هنا طلب من المستخدم إدخال رقم الوردية إذا لم يكن موجودًا
        // أو توجيه المستخدم إلى صفحة لإدخاله أولاً.
        alert('يرجى تعيين رقم الوردية في التخزين المحلي (localStorage).');
      }

      // جلب بيانات العمال من Google Sheet
      async function fetchWorkersData() {
        loadingMessage.style.display = 'block';
        try {
          const response = await fetch(dataSheetUrl);
          const text = await response.text();
          const jsonStartIndex = text.indexOf('google.visualization.Query.setResponse(') + 'google.visualization.Query.setResponse('.length;
          const jsonEndIndex = text.lastIndexOf(');');
          const jsonString = text.substring(jsonStartIndex, jsonEndIndex);
          const data = JSON.parse(jsonString);

          allWorkersData = data.table.rows.map(row => ({
            workerName: row.c[0] ? row.c[0].v : '',
            jobType: row.c[1] ? row.c[1].v : '',
            hourlyRate: row.c[2] ? row.c[2].v : 0
          }));

          populateJobTypes();
        } catch (error) {
          console.error('Error fetching workers data:', error);
          showStatusMessage('حدث خطأ أثناء جلب بيانات العمال.', 'error');
        } finally {
          loadingMessage.style.display = 'none';
        }
      }

      function populateJobTypes() {
        const jobTypes = [...new Set(allWorkersData.map(worker => worker.jobType))];
        jobTypeSelect.innerHTML = '<option value="">اختر اسم العمل</option>';
        jobTypes.forEach(jobType => {
          const option = document.createElement('option');
          option.value = jobType;
          option.textContent = jobType;
          jobTypeSelect.appendChild(option);
        });
        jobTypeSelect.disabled = false;
      }

      function populateWorkerNames(selectedJobType) {
        workerNameSelect.innerHTML = '<option value="">اختر اسم العامل</option>';
        if (selectedJobType) {
          const filteredWorkers = allWorkersData.filter(worker => worker.jobType === selectedJobType);
          const workerNames = filteredWorkers.map(worker => worker.workerName);
          workerNames.forEach(workerName => {
            const option = document.createElement('option');
            option.value = workerName;
            option.textContent = workerName;
            workerNameSelect.appendChild(option);
          });
          workerNameSelect.disabled = false;
        } else {
          workerNameSelect.disabled = true;
          searchButton.disabled = true;
        }
      }

      jobTypeSelect.addEventListener('change', () => {
        const selectedJobType = jobTypeSelect.value;
        populateWorkerNames(selectedJobType);
        workerDataSection.style.display = 'none';
        clearStatusMessage();
      });

      workerNameSelect.addEventListener('change', () => {
        if (workerNameSelect.value && jobTypeSelect.value) {
          searchButton.disabled = false;
        } else {
          searchButton.disabled = true;
        }
        workerDataSection.style.display = 'none';
        clearStatusMessage();
      });

      searchButton.addEventListener('click', async () => {
        const selectedJobType = jobTypeSelect.value;
        const selectedWorkerName = workerNameSelect.value;
        const shiftNumber = shiftNumberInput.value;

        if (!selectedJobType || !selectedWorkerName || !shiftNumber) {
          showStatusMessage('يرجى اختيار اسم العمل واسم العامل وتعيين رقم الوردية.', 'error');
          return;
        }

        loadingMessage.style.display = 'block';
        clearStatusMessage();
        workerDataSection.style.display = 'none';

        try {
          const params = new URLSearchParams({
            action: 'search',
            shiftNumber: shiftNumber,
            workerName: selectedWorkerName
          });
          const response = await fetch(`${scriptUrl}?${params.toString()}`);
          const result = await response.json();

          if (result.status === 'success' && result.data.length > 0) {
            const worker = result.data[0];
            currentRowIndex = worker.rowIndex;

            displayWorkerName.value = worker.workerName;
            displayJobType.value = worker.jobType;
            displayHourlyRate.value = worker.hourlyRate;
            displayShiftType.value = worker.shiftType;
            displayDayExpence.value = worker.dayExpence;

            inputComeTime.value = worker.comeTime;
            inputNumOfHours.value = worker.NumOfHours;
            inputDiscountWorker.value = worker.discountWorker;

            workerDataSection.style.display = 'block';
            showStatusMessage('تم جلب البيانات بنجاح.', 'success');
          } else {
            workerDataSection.style.display = 'none';
            showStatusMessage('لم يتم العثور على بيانات لهذا العامل في هذه الوردية.', 'error');
          }
        } catch (error) {
          console.error('Error searching worker data:', error);
          showStatusMessage('حدث خطأ أثناء البحث عن بيانات العامل.', 'error');
        } finally {
          loadingMessage.style.display = 'none';
        }
      });

      updateButton.addEventListener('click', async () => {
        if (currentRowIndex === null) {
          showStatusMessage('لا توجد بيانات لتحديثها. يرجى البحث أولاً.', 'error');
          return;
        }

        loadingMessage.style.display = 'block';
        clearStatusMessage();

        const updatedData = {
          comeTime: inputComeTime.value,
          NumOfHours: parseFloat(inputNumOfHours.value) || 0,
          discountWorker: parseFloat(inputDiscountWorker.value) || 0
        };

        try {
          const params = new URLSearchParams({
            action: 'update',
            rowIndex: currentRowIndex,
            data: JSON.stringify(updatedData)
          });
          const response = await fetch(scriptUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: params.toString()
          });
          const result = await response.json();

          if (result.status === 'success') {
            showStatusMessage('تم تحديث البيانات بنجاح!', 'success');
          } else {
            showStatusMessage(`فشل التحديث: ${result.message}`, 'error');
          }
        } catch (error) {
          console.error('Error updating worker data:', error);
          showStatusMessage('حدث خطأ أثناء تحديث البيانات.', 'error');
        } finally {
          loadingMessage.style.display = 'none';
        }
      });

      function showStatusMessage(message, type) {
        statusMessage.textContent = message;
        statusMessage.className = `message ${type}`;
        statusMessage.style.display = 'block';
      }

      function clearStatusMessage() {
        statusMessage.style.display = 'none';
        statusMessage.textContent = '';
        statusMessage.className = 'message';
      }

      // جلب البيانات عند تحميل الصفحة
      fetchWorkersData();
    });
  </script>
</body>
</html>