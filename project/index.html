<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="icon" href="./اساسيات/icon.png" type="image/x-icon">
    <link rel="stylesheet" href="./style.css">
    <title>The Rahmany Management</title>

</head>
<body>
<div class="startform">

    <h1> مرحبا بك </h1>
    <form id="loginForm">
        <p>  برجاء ادخال اسمك و رقم الودية الجديدة  </p><br>
        <input type="text" id="username" name="username"  placeholder="اسم المستخدم" required>
        <input type="text" id="shiftNum" name="shiftNum" placeholder="رقم الشيفت" required>
        <button type="submit" class="Create-btn" id="submitBtn">بحث</button>
    </form>

</div>
    <script>
        document.getElementById('loginForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    
    // تعطيل الزر وإظهار حالة التحميل
    submitBtn.classList.add('loading');
    
  
    
    // محاكاة انتظار الطلب (استبدل هذا بالوظيفة الفعلية)
    setTimeout(function() {
        submitBtn.classList.remove('loading');
        loadingMessage.style.display = 'none';
        
    }, 3000);
});
    </script>
    <script>
        document.getElementById('loginForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const username = document.getElementById('username').value.trim();
            const shiftNum = document.getElementById('shiftNum').value.trim();
        
            fetch('https://docs.google.com/spreadsheets/d/1a3pDcgzbcHsl3TNfgNQJGD_CZ3AcL1rvnubuXE8aAVI/gviz/tq?tqx=out:json')
                .then(response => response.text())
                .then(data => {
                    const jsonString = data.match(/google\.visualization\.Query\.setResponse\(([\s\S]+?)\);/)[1];
                    const jsonData = JSON.parse(jsonString);
                    const rows = jsonData.table.rows;
                    let shiftExists = false;
        
                    for (let row of rows) {
                        const rowData = row.c;
                        if (rowData && rowData[0] && rowData[1] &&
                            rowData[1].v.toString().trim() === shiftNum) {
                            shiftExists = true;
                            break;
                        }
                    }
        
                    if (shiftExists) {
                        alert('الشيفت دي مسجلة من قبل');
                    } else {
                        submitForm();
                    }
                })
                .catch(error => {
                    console.error('حدث خطأ:', error);
                });
        });
        
        function submitForm() {
            const scriptURL = "https://script.google.com/macros/s/AKfycbxmBCI1UdreaxaEZi87rXOEdpQjKcrGpTvusT33pv_my4ZyraFZyXiRpx745nf5ahvy/exec";
            const form = document.forms["loginForm"];
            const submitBtn = document.getElementById("submitBtn");
            const formData = new FormData(form);
            const formObject = Object.fromEntries(formData.entries());
            const username = document.getElementById('username').value.trim();
            const shiftNum = document.getElementById('shiftNum').value.trim();
            const redirectURL = './profile.html'; 

            // تخزين الإدخال الجديد بشكل منفصل
            localStorage.setItem('shiftNumber', shiftNum);
            localStorage.setItem('username', username);
        
            fetch(scriptURL, {
                method: "POST",
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    Swal.fire('تم بنجاح', 'تم تسجيل الدخول بنجاح', 'success');
                    form.reset();
                    setTimeout(function() { window.location.href = redirectURL;}, 500); 

                } else {
                    throw new Error('Network response was not ok');
                }
            })
            .catch(error => {
                Swal.fire('خطأ', 'حدث خطأ أثناء محاولة التسجيل', 'error');
                console.error('Error:', error);
            })
            .finally(() => {
                submitBtn.disabled = false;
            });
        }
    </script>
</body>
</html>